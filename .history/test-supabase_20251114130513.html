<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .status-box {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 5px solid;
        }
        .status-box.loading {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .status-box.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .status-box.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        button {
            background: #00a99d;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #008c82;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196F3;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 13px;
        }
        .code {
            font-family: 'Courier New', monospace;
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Supabase Connection Test</h1>
        <p class="subtitle">Let's verify your database is connected!</p>

        <!-- Connection Status -->
        <div id="connectionStatus" class="status-box loading">
            ‚è≥ Checking Supabase connection...
        </div>

        <!-- Configuration Info -->
        <div class="info">
            <strong>üìä Your Configuration:</strong><br>
            <strong>Project URL:</strong> <span class="code" id="projectUrl">Loading...</span><br>
            <strong>Table:</strong> <span class="code">verifications</span><br>
            <strong>Status:</strong> <span id="configStatus">Checking...</span>
        </div>

        <!-- Test Section 1: Read Test -->
        <div class="test-section">
            <h3>üìñ Test 1: Read from Database</h3>
            <p>Try to fetch existing verifications from your database.</p>
            <button onclick="testRead()" id="btnRead">Run Read Test</button>
            <div id="readResult"></div>
        </div>

        <!-- Test Section 2: Write Test -->
        <div class="test-section">
            <h3>‚úçÔ∏è Test 2: Write to Database</h3>
            <p>Insert a test verification record.</p>
            <button onclick="testWrite()" id="btnWrite">Run Write Test</button>
            <div id="writeResult"></div>
        </div>

        <!-- Test Section 3: Update Test -->
        <div class="test-section">
            <h3>üîÑ Test 3: Update Database</h3>
            <p>Update the test record with bank information.</p>
            <button onclick="testUpdate()" id="btnUpdate" disabled>Run Update Test</button>
            <div id="updateResult"></div>
        </div>

        <!-- Test Section 4: Delete Test -->
        <div class="test-section">
            <h3>üóëÔ∏è Test 4: Delete Test Data</h3>
            <p>Clean up test records from database.</p>
            <button onclick="testDelete()" id="btnDelete" disabled>Clean Up Test Data</button>
            <div id="deleteResult"></div>
        </div>

        <!-- Console Logs -->
        <div class="test-section">
            <h3>üìù Console Logs</h3>
            <pre id="consoleLogs">Console output will appear here...</pre>
        </div>
    </div>

    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="site/wp-content/supabase-config.js"></script>

    <script>
        let supabaseClient = null;
        let testSessionId = null;
        let consoleLogs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            consoleLogs.push(logMessage);
            document.getElementById('consoleLogs').textContent = consoleLogs.join('\n');
            
            if (type === 'error') {
                console.error(message);
            } else {
                console.log(message);
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Page loaded, initializing Supabase...');
            
            // Show config
            document.getElementById('projectUrl').textContent = SUPABASE_CONFIG.url;
            
            // Initialize Supabase
            try {
                supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                log('‚úÖ Supabase client created successfully!');
                document.getElementById('configStatus').textContent = '‚úÖ Connected';
                document.getElementById('connectionStatus').className = 'status-box success';
                document.getElementById('connectionStatus').innerHTML = '‚úÖ <strong>Supabase Connected Successfully!</strong><br>Your database is ready to use.';
            } catch (error) {
                log('‚ùå Failed to initialize Supabase: ' + error.message, 'error');
                document.getElementById('configStatus').textContent = '‚ùå Error';
                document.getElementById('connectionStatus').className = 'status-box error';
                document.getElementById('connectionStatus').innerHTML = '‚ùå <strong>Connection Failed</strong><br>' + error.message;
            }
        });

        // Test 1: Read
        async function testRead() {
            log('üìñ Starting Read Test...');
            const resultDiv = document.getElementById('readResult');
            resultDiv.innerHTML = '<p style="color: #ffc107;">‚è≥ Reading from database...</p>';
            
            try {
                const { data, error } = await supabaseClient
                    .from('verifications')
                    .select('*')
                    .limit(5);
                
                if (error) {
                    throw error;
                }
                
                log(`‚úÖ Read successful! Found ${data.length} records`);
                resultDiv.innerHTML = `
                    <div class="status-box success">
                        ‚úÖ <strong>Read Successful!</strong><br>
                        Found ${data.length} verification(s) in database
                    </div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                log('‚ùå Read failed: ' + error.message, 'error');
                resultDiv.innerHTML = `
                    <div class="status-box error">
                        ‚ùå <strong>Read Failed</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Test 2: Write
        async function testWrite() {
            log('‚úçÔ∏è Starting Write Test...');
            const resultDiv = document.getElementById('writeResult');
            resultDiv.innerHTML = '<p style="color: #ffc107;">‚è≥ Writing to database...</p>';
            
            testSessionId = 'test_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
            
            const testData = {
                session_id: testSessionId,
                uae_pass_data: {
                    fullName: 'Test User',
                    emiratesId: '784-1234-5678901-2',
                    email: 'test@example.com',
                    phone: '+971501234567',
                    nationality: 'UAE'
                },
                status: 'pending_bank_info',
                timestamp: new Date().toISOString()
            };
            
            try {
                const { data, error } = await supabaseClient
                    .from('verifications')
                    .insert([testData])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                log(`‚úÖ Write successful! Session ID: ${testSessionId}`);
                resultDiv.innerHTML = `
                    <div class="status-box success">
                        ‚úÖ <strong>Write Successful!</strong><br>
                        Test record created with session ID: <code>${testSessionId}</code>
                    </div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                
                // Enable update and delete buttons
                document.getElementById('btnUpdate').disabled = false;
                document.getElementById('btnDelete').disabled = false;
            } catch (error) {
                log('‚ùå Write failed: ' + error.message, 'error');
                resultDiv.innerHTML = `
                    <div class="status-box error">
                        ‚ùå <strong>Write Failed</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Test 3: Update
        async function testUpdate() {
            if (!testSessionId) {
                alert('Please run Write Test first!');
                return;
            }
            
            log('üîÑ Starting Update Test...');
            const resultDiv = document.getElementById('updateResult');
            resultDiv.innerHTML = '<p style="color: #ffc107;">‚è≥ Updating database...</p>';
            
            const bankData = {
                bankName: 'Test Bank',
                accountNumber: '1234567890',
                iban: 'AE070331234567890123456'
            };
            
            try {
                const { data, error } = await supabaseClient
                    .from('verifications')
                    .update({
                        bank_info: bankData,
                        status: 'pending_approval',
                        submitted_at: new Date().toISOString()
                    })
                    .eq('session_id', testSessionId)
                    .select();
                
                if (error) {
                    throw error;
                }
                
                log(`‚úÖ Update successful for session: ${testSessionId}`);
                resultDiv.innerHTML = `
                    <div class="status-box success">
                        ‚úÖ <strong>Update Successful!</strong><br>
                        Bank information added to test record
                    </div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                log('‚ùå Update failed: ' + error.message, 'error');
                resultDiv.innerHTML = `
                    <div class="status-box error">
                        ‚ùå <strong>Update Failed</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Test 4: Delete
        async function testDelete() {
            if (!testSessionId) {
                alert('Please run Write Test first!');
                return;
            }
            
            if (!confirm('Delete test record?')) {
                return;
            }
            
            log('üóëÔ∏è Starting Delete Test...');
            const resultDiv = document.getElementById('deleteResult');
            resultDiv.innerHTML = '<p style="color: #ffc107;">‚è≥ Deleting from database...</p>';
            
            try {
                const { data, error } = await supabaseClient
                    .from('verifications')
                    .delete()
                    .eq('session_id', testSessionId)
                    .select();
                
                if (error) {
                    throw error;
                }
                
                log(`‚úÖ Delete successful for session: ${testSessionId}`);
                resultDiv.innerHTML = `
                    <div class="status-box success">
                        ‚úÖ <strong>Delete Successful!</strong><br>
                        Test record removed from database
                    </div>
                `;
                
                // Reset
                testSessionId = null;
                document.getElementById('btnUpdate').disabled = true;
                document.getElementById('btnDelete').disabled = true;
            } catch (error) {
                log('‚ùå Delete failed: ' + error.message, 'error');
                resultDiv.innerHTML = `
                    <div class="status-box error">
                        ‚ùå <strong>Delete Failed</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
